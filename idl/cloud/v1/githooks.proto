syntax = "proto3";

package cloud.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

option go_package = "githook/pkg/gen/cloud/v1;cloudv1";

service InstallationsService {
  rpc ListInstallations(ListInstallationsRequest) returns (ListInstallationsResponse);
  rpc GetInstallationByID(GetInstallationByIDRequest) returns (GetInstallationByIDResponse);
  rpc UpsertInstallation(UpsertInstallationRequest) returns (UpsertInstallationResponse);
  rpc DeleteInstallation(DeleteInstallationRequest) returns (DeleteInstallationResponse);
}

service NamespacesService {
  rpc ListNamespaces(ListNamespacesRequest) returns (ListNamespacesResponse);
  rpc SyncNamespaces(SyncNamespacesRequest) returns (SyncNamespacesResponse);
  rpc GetNamespaceWebhook(GetNamespaceWebhookRequest) returns (GetNamespaceWebhookResponse);
  rpc SetNamespaceWebhook(SetNamespaceWebhookRequest) returns (SetNamespaceWebhookResponse);
}

service RulesService {
  rpc MatchRules(MatchRulesRequest) returns (MatchRulesResponse);
  rpc ListRules(ListRulesRequest) returns (ListRulesResponse);
  rpc GetRule(GetRuleRequest) returns (GetRuleResponse);
  rpc CreateRule(CreateRuleRequest) returns (CreateRuleResponse);
  rpc UpdateRule(UpdateRuleRequest) returns (UpdateRuleResponse);
  rpc DeleteRule(DeleteRuleRequest) returns (DeleteRuleResponse);
}

service DriversService {
  rpc ListDrivers(ListDriversRequest) returns (ListDriversResponse);
  rpc GetDriver(GetDriverRequest) returns (GetDriverResponse);
  rpc UpsertDriver(UpsertDriverRequest) returns (UpsertDriverResponse);
  rpc DeleteDriver(DeleteDriverRequest) returns (DeleteDriverResponse);
}

service ProvidersService {
  rpc ListProviders(ListProvidersRequest) returns (ListProvidersResponse);
  rpc GetProvider(GetProviderRequest) returns (GetProviderResponse);
  rpc UpsertProvider(UpsertProviderRequest) returns (UpsertProviderResponse);
  rpc DeleteProvider(DeleteProviderRequest) returns (DeleteProviderResponse);
}

service SCMService {
  rpc GetSCMClient(GetSCMClientRequest) returns (GetSCMClientResponse);
}

service EventLogsService {
  rpc ListEventLogs(ListEventLogsRequest) returns (ListEventLogsResponse);
  rpc GetEventLogAnalytics(GetEventLogAnalyticsRequest) returns (GetEventLogAnalyticsResponse);
  rpc GetEventLogTimeseries(GetEventLogTimeseriesRequest) returns (GetEventLogTimeseriesResponse);
  rpc GetEventLogBreakdown(GetEventLogBreakdownRequest) returns (GetEventLogBreakdownResponse);
  rpc UpdateEventLogStatus(UpdateEventLogStatusRequest) returns (UpdateEventLogStatusResponse);
}

message InstallRecord {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string account_id = 2 [(buf.validate.field).string.min_len = 1];
  string account_name = 3;
  string installation_id = 4 [(buf.validate.field).string.min_len = 1];
  string access_token = 5;
  string refresh_token = 6;
  google.protobuf.Timestamp expires_at = 7;
  string metadata_json = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
  string provider_instance_key = 11;
  string enterprise_id = 12;
  string enterprise_slug = 13;
  string enterprise_name = 14;
}

message NamespaceRecord {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string repo_id = 2;
  string account_id = 3;
  string installation_id = 4;
  string owner = 5;
  string repo_name = 6;
  string full_name = 7;
  string visibility = 8;
  string default_branch = 9;
  string http_url = 10;
  string ssh_url = 11;
  bool webhooks_enabled = 12;
  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp updated_at = 14;
}

message ListInstallationsRequest {
  // Optional account filter. When omitted, all accounts for the provider are returned.
  string state_id = 1;
  string provider = 2;
}

message ListInstallationsResponse {
  repeated InstallRecord installations = 1;
}

message GetInstallationByIDRequest {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string installation_id = 2 [(buf.validate.field).string.min_len = 1];
}

message GetInstallationByIDResponse {
  InstallRecord installation = 1;
}

message UpsertInstallationRequest {
  InstallRecord installation = 1 [(buf.validate.field).required = true];
}

message UpsertInstallationResponse {
  InstallRecord installation = 1;
}

message DeleteInstallationRequest {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string account_id = 2 [(buf.validate.field).string.min_len = 1];
  string installation_id = 3 [(buf.validate.field).string.min_len = 1];
  string provider_instance_key = 4;
}

message DeleteInstallationResponse {}

message ListNamespacesRequest {
  // Optional account filter. When omitted, all accounts for the provider are returned.
  string state_id = 1;
  string provider = 2;
  string owner = 3;
  string repo = 4;
  string full_name = 5;
}

message ListNamespacesResponse {
  repeated NamespaceRecord namespaces = 1;
}

message SyncNamespacesRequest {
  // Optional account filter. When omitted, all accounts for the provider are synced.
  string state_id = 1;
  string provider = 2 [(buf.validate.field).string.min_len = 1];
}

message SyncNamespacesResponse {
  repeated NamespaceRecord namespaces = 1;
}

message GetNamespaceWebhookRequest {
  // Optional account filter. When omitted, the namespace is resolved by provider + repo_id.
  string state_id = 1;
  string provider = 2 [(buf.validate.field).string.min_len = 1];
  string repo_id = 3 [(buf.validate.field).string.min_len = 1];
}

message SetNamespaceWebhookRequest {
  // Optional account filter. When omitted, the namespace is resolved by provider + repo_id.
  string state_id = 1;
  string provider = 2 [(buf.validate.field).string.min_len = 1];
  string repo_id = 3 [(buf.validate.field).string.min_len = 1];
  bool enabled = 4;
}

message GetNamespaceWebhookResponse {
  bool enabled = 1;
}

message SetNamespaceWebhookResponse {
  bool enabled = 1;
}

message Rule {
  string when = 1 [(buf.validate.field).string.min_len = 1];
  repeated string emit = 2 [
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.max_items = 1,
    (buf.validate.field).repeated.items.string.min_len = 1
  ];
  string driver_id = 4 [(buf.validate.field).string.min_len = 1];
}

message RuleRecord {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  string when = 2 [(buf.validate.field).string.min_len = 1];
  repeated string emit = 3 [
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.items.string.min_len = 1
  ];
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
  string driver_id = 7 [(buf.validate.field).string.min_len = 1];
}

message DriverRecord {
  string name = 1 [(buf.validate.field).string.min_len = 1];
  string config_json = 2;
  bool enabled = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp updated_at = 5;
  string id = 6;
}

message ProviderRecord {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  // Instance hash (server-generated).
  string hash = 2;
  string config_json = 3;
  bool enabled = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
  // Per-instance OAuth redirect URL (overrides global redirect_base_url).
  string redirect_base_url = 7;
}

message SCMClient {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string api_base_url = 2;
  string access_token = 3 [(buf.validate.field).string.min_len = 1];
  google.protobuf.Timestamp expires_at = 4;
  string provider_instance_key = 5;
}

message GetSCMClientRequest {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string installation_id = 2 [(buf.validate.field).string.min_len = 1];
  string provider_instance_key = 3;
}

message GetSCMClientResponse {
  SCMClient client = 1;
}

message EventLogHeaderValues {
  repeated string values = 1;
}

message EventLogRecord {
  string id = 1;
  string provider = 2;
  string name = 3;
  string request_id = 4;
  string state_id = 5;
  string installation_id = 6;
  string namespace_id = 7;
  string namespace_name = 8;
  string topic = 9;
  string rule_id = 10;
  string rule_when = 11;
  repeated string drivers = 12;
  bool matched = 13;
  string status = 14;
  string error_message = 15;
  google.protobuf.Timestamp created_at = 16;
  google.protobuf.Timestamp updated_at = 17;
  map<string, EventLogHeaderValues> headers = 18;
  bytes body = 19;
  string body_hash = 20;
}

message EventLogCount {
  string key = 1;
  int64 count = 2;
}

message EventLogAnalytics {
  int64 total = 1;
  int64 matched = 2;
  int64 distinct_requests = 3;
  repeated EventLogCount by_provider = 4;
  repeated EventLogCount by_event = 5;
  repeated EventLogCount by_topic = 6;
  repeated EventLogCount by_rule = 7;
  repeated EventLogCount by_installation = 8;
  repeated EventLogCount by_namespace = 9;
}

enum EventLogTimeseriesInterval {
  EVENT_LOG_TIMESERIES_INTERVAL_UNSPECIFIED = 0;
  EVENT_LOG_TIMESERIES_INTERVAL_HOUR = 1;
  EVENT_LOG_TIMESERIES_INTERVAL_DAY = 2;
  EVENT_LOG_TIMESERIES_INTERVAL_WEEK = 3;
}

message EventLogTimeseriesBucket {
  google.protobuf.Timestamp start_time = 1;
  google.protobuf.Timestamp end_time = 2;
  int64 event_count = 3;
  int64 matched_count = 4;
  int64 distinct_requests = 5;
  int64 failed_count = 6;
}

enum EventLogBreakdownGroup {
  EVENT_LOG_BREAKDOWN_GROUP_UNSPECIFIED = 0;
  EVENT_LOG_BREAKDOWN_GROUP_PROVIDER = 1;
  EVENT_LOG_BREAKDOWN_GROUP_EVENT = 2;
  EVENT_LOG_BREAKDOWN_GROUP_RULE_ID = 3;
  EVENT_LOG_BREAKDOWN_GROUP_RULE_WHEN = 4;
  EVENT_LOG_BREAKDOWN_GROUP_TOPIC = 5;
  EVENT_LOG_BREAKDOWN_GROUP_NAMESPACE_ID = 6;
  EVENT_LOG_BREAKDOWN_GROUP_NAMESPACE_NAME = 7;
  EVENT_LOG_BREAKDOWN_GROUP_INSTALLATION_ID = 8;
}

enum EventLogBreakdownSort {
  EVENT_LOG_BREAKDOWN_SORT_UNSPECIFIED = 0;
  EVENT_LOG_BREAKDOWN_SORT_COUNT = 1;
  EVENT_LOG_BREAKDOWN_SORT_MATCHED = 2;
  EVENT_LOG_BREAKDOWN_SORT_FAILED = 3;
}

message EventLogBreakdown {
  string key = 1;
  int64 event_count = 2;
  int64 matched_count = 3;
  int64 failed_count = 4;
  double latency_p50_ms = 5;
  double latency_p95_ms = 6;
  double latency_p99_ms = 7;
}

message EventPayload {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string name = 2 [(buf.validate.field).string.min_len = 1];
  bytes payload = 3 [(buf.validate.field).bytes.min_len = 1];
}

message RuleMatch {
  string when = 1;
  repeated string emit = 2;
  string driver_id = 4;
}

message MatchRulesRequest {
  EventPayload event = 1 [(buf.validate.field).required = true];
  repeated Rule rules = 2 [(buf.validate.field).repeated.min_items = 1];
  bool strict = 3;
}

message MatchRulesResponse {
  repeated RuleMatch matches = 1;
}

message ListRulesRequest {}

message ListRulesResponse {
  repeated RuleRecord rules = 1;
}

message GetRuleRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
}

message GetRuleResponse {
  RuleRecord rule = 1;
}

message CreateRuleRequest {
  Rule rule = 1 [(buf.validate.field).required = true];
}

message CreateRuleResponse {
  RuleRecord rule = 1;
}

message UpdateRuleRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  Rule rule = 2 [(buf.validate.field).required = true];
}

message UpdateRuleResponse {
  RuleRecord rule = 1;
}

message DeleteRuleRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
}

message DeleteRuleResponse {}

message ListDriversRequest {}

message ListDriversResponse {
  repeated DriverRecord drivers = 1;
}

message GetDriverRequest {
  string name = 1 [(buf.validate.field).string.min_len = 1];
}

message GetDriverResponse {
  DriverRecord driver = 1;
}

message UpsertDriverRequest {
  DriverRecord driver = 1 [(buf.validate.field).required = true];
}

message UpsertDriverResponse {
  DriverRecord driver = 1;
}

message DeleteDriverRequest {
  string name = 1 [(buf.validate.field).string.min_len = 1];
}

message DeleteDriverResponse {}

message ListProvidersRequest {
  string provider = 1;
}

message ListProvidersResponse {
  repeated ProviderRecord providers = 1;
}

message GetProviderRequest {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string hash = 2 [(buf.validate.field).string.min_len = 1];
}

message GetProviderResponse {
  ProviderRecord provider = 1;
}

message UpsertProviderRequest {
  ProviderRecord provider = 1 [(buf.validate.field).required = true];
}

message UpsertProviderResponse {
  ProviderRecord provider = 1;
}

message DeleteProviderRequest {
  string provider = 1 [(buf.validate.field).string.min_len = 1];
  string hash = 2 [(buf.validate.field).string.min_len = 1];
}

message DeleteProviderResponse {}

message ListEventLogsRequest {
  string provider = 1;
  string name = 2;
  string topic = 3;
  string request_id = 4;
  string state_id = 5;
  string installation_id = 6;
  string namespace_id = 7;
  string namespace_name = 8;
  string rule_id = 9;
  string rule_when = 10;
  bool matched_only = 11;
  int32 page_size = 12 [(buf.validate.field).int32.gte = 0, (buf.validate.field).int32.lte = 200];
  string page_token = 13;
  google.protobuf.Timestamp start_time = 14;
  google.protobuf.Timestamp end_time = 15;
}

message ListEventLogsResponse {
  repeated EventLogRecord logs = 1;
  string next_page_token = 2;
}

message GetEventLogAnalyticsRequest {
  string provider = 1;
  string name = 2;
  string topic = 3;
  string request_id = 4;
  string state_id = 5;
  string installation_id = 6;
  string namespace_id = 7;
  string namespace_name = 8;
  string rule_id = 9;
  string rule_when = 10;
  bool matched_only = 11;
  google.protobuf.Timestamp start_time = 12;
  google.protobuf.Timestamp end_time = 13;
}

message GetEventLogAnalyticsResponse {
  EventLogAnalytics analytics = 1;
}

message GetEventLogTimeseriesRequest {
  string provider = 1;
  string name = 2;
  string topic = 3;
  string request_id = 4;
  string state_id = 5;
  string installation_id = 6;
  string namespace_id = 7;
  string namespace_name = 8;
  string rule_id = 9;
  string rule_when = 10;
  bool matched_only = 11;
  google.protobuf.Timestamp start_time = 12;
  google.protobuf.Timestamp end_time = 13;
  EventLogTimeseriesInterval interval = 14 [(buf.validate.field).enum.not_in = 0];
}

message GetEventLogTimeseriesResponse {
  repeated EventLogTimeseriesBucket buckets = 1;
}

message GetEventLogBreakdownRequest {
  string provider = 1;
  string name = 2;
  string topic = 3;
  string request_id = 4;
  string state_id = 5;
  string installation_id = 6;
  string namespace_id = 7;
  string namespace_name = 8;
  string rule_id = 9;
  string rule_when = 10;
  bool matched_only = 11;
  google.protobuf.Timestamp start_time = 12;
  google.protobuf.Timestamp end_time = 13;
  EventLogBreakdownGroup group_by = 14 [(buf.validate.field).enum.not_in = 0];
  EventLogBreakdownSort sort_by = 15;
  bool sort_desc = 16;
  int32 page_size = 17 [(buf.validate.field).int32.gte = 0, (buf.validate.field).int32.lte = 200];
  string page_token = 18;
  bool include_latency = 19;
}

message GetEventLogBreakdownResponse {
  repeated EventLogBreakdown breakdowns = 1;
  string next_page_token = 2;
}

message UpdateEventLogStatusRequest {
  string log_id = 1 [(buf.validate.field).string.min_len = 1];
  string status = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.in = "queued",
    (buf.validate.field).string.in = "delivered",
    (buf.validate.field).string.in = "success",
    (buf.validate.field).string.in = "failed"
  ];
  string error_message = 3;
}

message UpdateEventLogStatusResponse {}
