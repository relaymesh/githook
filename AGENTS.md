# PROJECT KNOWLEDGE BASE

**Generated:** 2026-02-27
**Commit:** 0ffd885
**Branch:** main

## OVERVIEW

githook is a multi-tenant webhook router for GitHub/GitLab/Bitbucket. Receives SCM events, evaluates rule expressions, publishes matches to AMQP/NATS/Kafka via Relaybus. Worker SDKs (Go/TypeScript/Python) consume events and fetch server-side SCM credentials.

**Status:** R&D only — not production-ready (per README).

## STRUCTURE

```
githooks/
├── main.go              # Single entry point → cmd.NewRootCmd().Execute()
├── cmd/                 # Cobra CLI: serve, rules, drivers, providers, installations, namespaces, auth, init
├── pkg/                 # Server-side logic (see pkg/AGENTS.md)
│   ├── core/            # Config, rules engine, publisher, event model
│   ├── server/          # HTTP server, auth/tenant interceptors, handler wiring
│   ├── api/             # ConnectRPC service implementations (7 services)
│   ├── webhook/         # Provider-specific webhook ingestion + event routing
│   ├── oauth/           # OAuth2 flows per provider
│   ├── auth/            # OIDC verification, provider auth config
│   ├── storage/         # GORM-based persistence (6 interfaces, 6 implementations)
│   ├── drivers/         # Driver config cache + dynamic publisher
│   ├── providers/       # GitHub/GitLab/Bitbucket SDK wrappers
│   ├── scm/             # Unified SCM client factory
│   ├── providerinstance/# Per-tenant provider config + cache
│   └── gen/             # Generated protobuf/ConnectRPC stubs (DO NOT EDIT)
├── sdk/                 # Worker SDKs (see sdk/AGENTS.md)
│   ├── go/worker/       # Reference implementation (34 files)
│   ├── typescript/worker/
│   └── python/worker/
├── idl/cloud/v1/        # githooks.proto — single proto defining 7 services
├── examples/            # Go/TS/Python worker examples
├── docs/                # Provider setup, rules DSL, drivers, auth, CLI reference
├── scripts/             # send_webhook.sh — manual webhook testing
└── .github/workflows/   # ci, release (GoReleaser+Docker+npm+PyPI), buf-ci, helm
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add CLI command | `cmd/` | Follow Cobra pattern in `root.go`. Each command = own file |
| Change API schema | `idl/cloud/v1/githooks.proto` | Then `buf generate` to regen `pkg/gen/` + SDK stubs |
| Add webhook provider | `pkg/webhook/` + `pkg/providers/` | Implement `Provider` interface in `webhook/registry.go` |
| Add OAuth provider | `pkg/oauth/` | Implement handler + register in `oauth/registry.go` |
| Modify rule evaluation | `pkg/core/rules.go` | Uses `govaluate` expressions. Custom funcs in `rules_functions.go` |
| Add storage entity | `pkg/storage/store.go` | Define interface, impl in new subdir, wire in `server/server_build.go` |
| Change server wiring | `pkg/server/server_build.go` | `BuildHandler()` wires all services, stores, caches |
| Worker SDK changes | `sdk/{go,typescript,python}/worker/` | Keep all 3 in parity. Go is reference impl |
| Config changes | `pkg/core/config.go` | Defaults in `applyDefaults()`. YAML tags define schema |
| Auth changes | `pkg/auth/` + `pkg/server/auth_interceptor.go` | OIDC via `pkg/auth/oidc/` |

## CONVENTIONS

- **Protobuf-first**: All API contracts defined in `githooks.proto`. Code generated for Go (ConnectRPC+gRPC), TypeScript (ES), Python
- **ConnectRPC** (not raw gRPC): HTTP/1.1 + HTTP/2 compatible. Uses `connectrpc.com/connect`
- **GORM for storage**: PostgreSQL/MySQL/SQLite. Each entity has own subpackage under `pkg/storage/`
- **Multi-tenancy**: `X-Tenant-ID` header → `tenant_interceptor.go` → context propagation → storage filtering
- **Deterministic IDs**: `storage.InstallRecordID()`, `NamespaceRecordID()` use SHA256 of key fields
- **Relaybus abstraction**: Message broker operations go through `github.com/relaymesh/relaybus`, not broker SDKs directly
- **Functional options**: Worker SDKs use `With*()` option pattern for configuration
- **Registry pattern**: Webhook providers and OAuth providers registered via registries, iterated in `server_build.go`
- **No linter config**: Standard `go test ./...` and `go build ./...` only. No golangci-lint

## ANTI-PATTERNS (THIS PROJECT)

- **Never edit `pkg/gen/`** — auto-generated by `buf generate`. Modify `.proto` instead
- **Never store secrets in workers** — SCM credentials fetched server-side via `SCMService.GetSCMClient`
- **Never import upward** — `core/` and `storage/` must not import from `server/`, `api/`, or `webhook/`
- **config.yaml in repo has real credentials** — `.envrc` and `config.yaml` contain Auth0/Supabase secrets. Do not commit new secrets

## COMMANDS

```bash
# Dev
go build -o githook ./main.go
go test ./...
githook serve --config config.yaml

# Local infra (PostgreSQL, RabbitMQ, Kafka, NATS, MySQL)
docker-compose up -d

# Proto codegen (requires buf CLI)
buf generate

# Proto validation
buf lint
buf breaking --against '.git#branch=main'

# Release (automated via tags)
git tag v1.0.0 && git push --tags   # triggers GoReleaser + Docker + npm + PyPI

# Worker examples
cd examples && make run-go
cd examples && make run-typescript
cd examples && make run-python

# Manual webhook test
./scripts/send_webhook.sh github '{"action":"opened"}'
```

## DATA FLOW

```
GitHub/GitLab/Bitbucket webhook
  → /webhooks/{provider}
  → signature verification
  → parse payload → core.Event (flatten JSON to dot-notation)
  → core.RuleEngine.Match() (govaluate expressions)
  → for each match: core.Publisher.Publish() → Relaybus → AMQP/NATS/Kafka
  → EventLogStore.Create() (audit trail)

Worker SDK
  → HandleRule("rule-id") → fetch rule from server API
  → resolve driver config → subscribe to broker topic
  → decode EventPayload (protobuf) → dispatch to handler
  → optional: GetSCMClient() for provider API access
  → UpdateEventLogStatus() (delivered/success/failed)
```

## NOTES

- Go 1.24 required (set in `go.mod`)
- `buf.gen.yaml` generates code for 3 languages from single `.proto`
- Release workflow uses Go 1.25 (intentional — forward-compatible build)
- Docker build hardcodes `GOARCH=amd64`; release builds `amd64+arm64`
- `.envrc` expects `direnv` for automatic env loading
- No test framework — standard `testing` package only
- SDKs (TS/Python) have no unit tests; tested via `examples/`
- Fly.io is deployment target (`fly.toml`); port 8080 hardcoded
